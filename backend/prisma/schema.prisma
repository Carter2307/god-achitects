generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- UTILISATEURS ---
model User {
  id               String   @id @default(uuid())
  nom              String
  prenom           String
  email            String   @unique
  motDePasse       String
  role             Role
  statut           Statut   @default(ACTIF)
  dateCreation     DateTime @default(now())
  dateModification DateTime @updatedAt

  reservations        Reservation[]
  reservationHistories ReservationHistory[]
}

enum Role {
  EMPLOYE
  GESTIONNAIRE
  SECRETAIRE
}

enum Statut {
  ACTIF
  INACTIF
}

// --- PLACES DE PARKING ---
model ParkingSpot {
  id                  String      @id @default(uuid())
  numero              String      @unique
  rangee              String
  aChargeurElectrique Boolean     @default(false)
  statut              SpotStatus  @default(DISPONIBLE)
  qrCodeUrl           String
  dateCreation        DateTime    @default(now())
  
  reservations        Reservation[]
}

enum SpotStatus {
  DISPONIBLE
  RESERVEE
  OCCUPEE
}

// --- RÃ‰SERVATIONS ---
model Reservation {
  id             String            @id @default(uuid())
  userId         String
  parkingSpotId  String
  dateDebut      DateTime
  dateFin        DateTime
  besoinChargeur Boolean           @default(false)
  statut         ReservationStatus @default(EN_ATTENTE)
  dateCreation   DateTime          @default(now())
  dateModification DateTime        @updatedAt

  user           User              @relation(fields: [userId], references: [id])
  parkingSpot    ParkingSpot       @relation(fields: [parkingSpotId], references: [id])
  checkIn        CheckIn?
  histories      ReservationHistory[]
  messages       QueueMessage[]
}

enum ReservationStatus {
  EN_ATTENTE
  CONFIRMEE
  OCCUPEE
  EXPIREE
  ANNULEE
}

// --- ENREGISTREMENT (CHECK-IN) ---
model CheckIn {
  id            String      @id @default(uuid())
  reservationId String      @unique
  dateHeure     DateTime    @default(now())
  methode       CheckInMethod
  dateCreation  DateTime    @default(now())

  reservation   Reservation @relation(fields: [reservationId], references: [id])
}

enum CheckInMethod {
  QR_CODE
  MANUEL
}

// --- HISTORIQUE & MESSAGERIE ---
model ReservationHistory {
  id            String      @id @default(uuid())
  reservationId String
  userId        String
  action        String      // Ex: CREATION, ANNULATION
  ancienneValeur Json?
  nouvelleValeur Json?
  dateHeure     DateTime    @default(now())

  reservation   Reservation @relation(fields: [reservationId], references: [id])
  user          User        @relation(fields: [userId], references: [id])
}

model QueueMessage {
  id              String        @id @default(uuid())
  reservationId   String
  typeMessage     MessageType
  statut          QueueStatus   @default(EN_ATTENTE)
  nombreTentatives Int          @default(0)
  dateCreation    DateTime      @default(now())
  dateTraitement  DateTime?

  reservation     Reservation   @relation(fields: [reservationId], references: [id])
}

enum MessageType {
  CONFIRMATION
  ANNULATION
  RAPPEL
  EXPIRATION
}

enum QueueStatus {
  EN_ATTENTE
  TRAITE
  ECHEC
}